name: Reusable Build & Deploy

on:
  workflow_call:
    inputs:
      service_path:
        required: true
        type: string
        description: "Folder path (FE or BE)"
      image_name:
        required: true
        type: string
        description: "Name of the image in ACR"
      deployment_dev:
        required: true
        type: string
        description: "K8s Deployment name for Dev"
      deployment_stage:
        required: true
        type: string
        description: "K8s Deployment name for Stage"
      deployment_prod:
        required: true
        type: string
        description: "K8s Deployment name for Production"
    secrets:
      ACR_LOGIN_SERVER:
        required: true
      ACR_USERNAME:
        required: true
      ACR_PASSWORD:
        required: true
      AZURE_CREDENTIALS:
        required: true
      DEV_CLUSTER_NAME:
        required: true
      DEV_RESOURCE_GROUP:
        required: true
      STAGE_CLUSTER_NAME:
        required: true
      STAGE_RESOURCE_GROUP:
        required: true
      PROD_CLUSTER_NAME:
        required: true
      PROD_RESOURCE_GROUP:
        required: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Version Tag
        id: get_version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "VERSION=stage" >> $GITHUB_OUTPUT
          else
            echo "VERSION=dev" >> $GITHUB_OUTPUT
          fi

      - name: Log in to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.ACR_LOGIN_SERVER }}/${{ inputs.image_name }}
          tags: |
            type=raw,value=dev,enable=${{ github.ref == 'refs/heads/dev' }}
            type=raw,value=stage,enable=${{ github.ref == 'refs/heads/master' }}
            type=semver,pattern=production-{{version}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./${{ inputs.service_path }}
          file: ./${{ inputs.service_path }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            ENVIRONMENT=${{ steps.get_version.outputs.VERSION }}

      - name: Azure Login
        if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/master'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Non-Prod (Dev/Stage)
        if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/master'
        run: |
          # Logic: Explicitly check for 'dev' or 'master'
          
          if [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "Deploying to DEV environment..."
            CLUSTER="${{ secrets.DEV_CLUSTER_NAME }}"
            RG="${{ secrets.DEV_RESOURCE_GROUP }}"
            DEPLOYMENT="${{ inputs.deployment_dev }}"
          
            az aks get-credentials --resource-group $RG --name $CLUSTER
            kubectl rollout restart deployment/$DEPLOYMENT -n default

          elif [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "Deploying to STAGE environment..."
            CLUSTER="${{ secrets.STAGE_CLUSTER_NAME }}"  # <--- Now using Secret
            RG="${{ secrets.STAGE_RESOURCE_GROUP }}"
            DEPLOYMENT="${{ inputs.deployment_stage }}"
          
            az aks get-credentials --resource-group $RG --name $CLUSTER
          
            # Patch env variable for stage (if required) and restart
            kubectl patch deployment $DEPLOYMENT -n default --type='json' -p="[{\"op\": \"replace\", \"path\": \"/spec/template/spec/containers/0/env/1/value\", \"value\": \"stage\"}]"
            kubectl rollout restart deployment/$DEPLOYMENT -n default
          fi

  deploy-production:
    needs: build-and-push
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Connect to AKS Production
        uses: azure/aks-set-context@v3
        with:
          cluster-name: ${{ secrets.PROD_CLUSTER_NAME }}
          resource-group: ${{ secrets.PROD_RESOURCE_GROUP }}

      - name: Update Production Image
        run: |
          VERSION="${{ needs.build-and-push.outputs.version }}"
          NEW_IMAGE="${{ secrets.ACR_LOGIN_SERVER }}/${{ inputs.image_name }}:production-$VERSION"
          DEPLOYMENT="${{ inputs.deployment_prod }}"
          
          echo "Deploying version $VERSION to Production..."
          
          kubectl patch deployment $DEPLOYMENT -n default --patch "{
            \"spec\": {
              \"template\": {
                \"spec\": {
                  \"containers\": [
                    {
                      \"name\": \"$DEPLOYMENT\",
                      \"image\": \"$NEW_IMAGE\",
                      \"env\": [
                        { \"name\": \"CODE_VERSION\", \"value\": \"$VERSION\" }
                      ]
                    }
                  ]
                }
              }
            }
          }"
          kubectl rollout status deployment/$DEPLOYMENT -n default --timeout=2m
