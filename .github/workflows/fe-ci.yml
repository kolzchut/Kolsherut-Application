#name: FE CI (staging)
## Builds FE on any branch when FE files change. Deploys (staging) only on main.
## Production (tag) deployment handled by fe-release.yml.
#on:
#  push:
#    branches:
#      - main
#    paths:
#      - 'FE/**'
#      - '.github/workflows/fe-ci.yml'
#
#permissions:
#  contents: write
#  packages: write
#
#concurrency:
#  group: fe-${{ github.ref }}
#  cancel-in-progress: true
#
#jobs:
#  build-and-deploy:
#    runs-on: ubuntu-22.04
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#
#      - name: Login to GHCR
#        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
#
#      - name: Setup Node
#        uses: actions/setup-node@v4
#        with:
#          node-version: 20
#          cache: npm
#          cache-dependency-path: FE/package-lock.json
#
#      - name: Install Dependencies
#        working-directory: FE
#        run: npm ci
#
#      - name: Generate Sitemaps (stage)
#        working-directory: FE
#        run: |
#          npx cross-env ENVIRONMENT=stage npm run sitemap:homepage
#          npx cross-env ENVIRONMENT=stage npm run sitemap:main
#
#
#      - name: Build FE (Vite, no SSG)
#        working-directory: FE
#        run: npm run build:stage:base
#
#      - name: Docker Build (no SSG)
#        env:
#          IMAGE_NAME: kol-sherut-fe
#        working-directory: FE
#        run: |
#          BUILD_ARGS=""
#          if docker pull ghcr.io/kolzchut/${IMAGE_NAME}:latest; then
#            BUILD_ARGS="--cache-from ghcr.io/kolzchut/${IMAGE_NAME}:latest"
#          fi
#          # decide build environment: stage on main, local otherwise
#          ENV_ARG="local"
#          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then ENV_ARG="stage"; fi
#          docker build -t fe-build-base $BUILD_ARGS --build-arg environment=${ENV_ARG} .
#
#      - name: Push & Update Helm (No-SSG)
#        if: github.ref == 'refs/heads/main'
#        env:
#          IMAGE_NAME: kol-sherut-fe
#          CHART_NAME: site
#          SRM_DEVOPS_DEPLOY_KEY: ${{ secrets.SRM_DEVOPS_DEPLOY_KEY }}
#        run: |
#          # 1. Push no-SSG images
#          IMAGE_TAG="${GITHUB_SHA}"
#          FULL_IMAGE="ghcr.io/kolzchut/${IMAGE_NAME}:${IMAGE_TAG}"
#          docker tag fe-build-base "$FULL_IMAGE"
#          docker push "$FULL_IMAGE"
#
#          # 2. Update Helm (using No-SSG image temporarily)
#          rm -f srm_devops_deploy_key
#          printf "%s" "$SRM_DEVOPS_DEPLOY_KEY" | tr -d '\r' > srm_devops_deploy_key
#          chmod 400 srm_devops_deploy_key
#          export GIT_SSH_COMMAND="ssh -i $(pwd)/srm_devops_deploy_key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"
#          rm -rf srm-devops
#          git clone git@github.com:kolzchut/srm-devops.git
#          git config --global user.name "srm-devops CI"
#          git config --global user.email "srm-devops-ci@localhost"
#          cd srm-devops
#          VALUES_FILE="helm/${CHART_NAME}/values.auto-updated.yaml"
#          echo "Updating $VALUES_FILE with image: $FULL_IMAGE"
#          echo "Before (image lines):" && (grep -n 'image:' "$VALUES_FILE" || true)
#          if [ -f "bin/update_yaml.py" ]; then
#             bin/update_yaml.py '{"'"${CHART_NAME}"'":{"image":"'"${FULL_IMAGE}"'"}}' "$VALUES_FILE"
#          else
#             # Fallback if script location differs, though it seems standard in your repo
#             ../srm-devops/bin/update_yaml.py '{"'"${CHART_NAME}"'":{"image":"'"${FULL_IMAGE}"'"}}' "$VALUES_FILE"
#          fi
#          echo "After  (image lines):" && (grep -n 'image:' "$VALUES_FILE" || true)
#          echo "Git diff for $VALUES_FILE (if any):" && (git diff -- "$VALUES_FILE" || true)
#          git add "$VALUES_FILE"
#          git commit -m "FE staging image update (No-SSG): $VALUES_FILE" || echo "No changes to commit"
#          git push origin main
#          cd ..
#          rm -f srm_devops_deploy_key
#          rm -rf srm-devops
#
#      - name: Build FE (SSG)
#        if: github.ref == 'refs/heads/main'
#        working-directory: FE
#        run: npm run build:stage
#
#      - name: Docker Build (SSG)
#        if: github.ref == 'refs/heads/main'
#        env:
#          IMAGE_NAME: kol-sherut-fe
#        working-directory: FE
#        run: |
#          BUILD_ARGS=""
#          if docker pull ghcr.io/kolzchut/${IMAGE_NAME}:latest; then
#            BUILD_ARGS="--cache-from ghcr.io/kolzchut/${IMAGE_NAME}:latest"
#          fi
#          # decide build environment: stage on main, local otherwise
#          ENV_ARG="local"
#          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then ENV_ARG="stage"; fi
#          docker build -t fe-build-ssg $BUILD_ARGS --build-arg environment=${ENV_ARG} .
#
#      - name: Push & Update Helm (SSG)
#        if: github.ref == 'refs/heads/main'
#        env:
#          IMAGE_NAME: kol-sherut-fe
#          CHART_NAME: site
#          SRM_DEVOPS_DEPLOY_KEY: ${{ secrets.SRM_DEVOPS_DEPLOY_KEY }}
#        run: |
#          # 1. Push SSG images
#          IMAGE_TAG_SSG="${GITHUB_SHA}-SSG"
#          FULL_IMAGE_SSG="ghcr.io/kolzchut/${IMAGE_NAME}:${IMAGE_TAG_SSG}"
#          docker tag fe-build-ssg "$FULL_IMAGE_SSG"
#          docker push "$FULL_IMAGE_SSG"
#          docker tag fe-build-ssg ghcr.io/kolzchut/${IMAGE_NAME}:latest
#          docker push ghcr.io/kolzchut/${IMAGE_NAME}:latest
#
#          # 2. Update Helm (using SSG image)
#          rm -f srm_devops_deploy_key
#          printf "%s" "$SRM_DEVOPS_DEPLOY_KEY" | tr -d '\r' > srm_devops_deploy_key
#          chmod 400 srm_devops_deploy_key
#          export GIT_SSH_COMMAND="ssh -i $(pwd)/srm_devops_deploy_key -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"
#          rm -rf srm-devops
#          git clone git@github.com:kolzchut/srm-devops.git
#          git config --global user.name "srm-devops CI"
#          git config --global user.email "srm-devops-ci@localhost"
#          cd srm-devops
#          VALUES_FILE="helm/${CHART_NAME}/values.auto-updated.yaml"
#          echo "Updating $VALUES_FILE with image: $FULL_IMAGE_SSG"
#          echo "Before (image lines):" && (grep -n 'image:' "$VALUES_FILE" || true)
#          bin/update_yaml.py '{"'"${CHART_NAME}"'":{"image":"'"${FULL_IMAGE_SSG}"'"}}' "$VALUES_FILE"
#          echo "After  (image lines):" && (grep -n 'image:' "$VALUES_FILE" || true)
#          echo "Git diff for $VALUES_FILE (if any):" && (git diff -- "$VALUES_FILE" || true)
#          git add "$VALUES_FILE"
#          git commit -m "FE staging image update (including SSG): $VALUES_FILE" || echo "No changes to commit"
#          git push origin main
#          cd ..
#          rm -f srm_devops_deploy_key
#          rm -rf srm-devops
